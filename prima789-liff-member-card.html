<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima789 Member Card</title>
    
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Inline CSS (‡πÅ‡∏ó‡∏ô CDN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CSP) -->
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #111827; 
            color: #ffffff; 
            min-height: 100vh;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .max-w-md { max-width: 28rem; margin: 0 auto; }
        .min-h-screen { min-height: 100vh; }
        
        /* Spacing */
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mr-4 { margin-right: 1rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        
        /* Colors */
        .text-amber-400 { color: #fbbf24; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-red-400 { color: #f87171; }
        .text-green-400 { color: #4ade80; }
        
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-red-700 { background-color: #b91c1c; }
        .bg-red-900 { background-color: #7f1d1d; }
        .bg-amber-400 { background-color: #fbbf24; }
        
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        
        /* Typography */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-4xl { font-size: 2.25rem; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        
        /* Layout */
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .border-2 { border-width: 2px; }
        .border-amber-400 { border-color: #fbbf24; }
        .border-gray-700 { border-color: #374151; }
        .transition { transition: all 0.3s ease; }
        
        /* Flex specific */
        .flex-1 { flex: 1; }
        
        /* Sizing */
        .w-3 { width: 0.75rem; }
        .h-3 { height: 0.75rem; }
        .w-16 { width: 4rem; }
        .h-16 { height: 4rem; }
        .w-20 { width: 5rem; }
        .h-20 { height: 5rem; }
        .w-24 { width: 6rem; }
        .h-24 { height: 6rem; }
        
        /* Animations */
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-spin { animation: spin 1s linear infinite; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #fbbf24;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        /* Button styles */
        .btn {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1f2937;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        .btn-secondary {
            background-color: #374151;
            color: #ffffff;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-danger {
            background-color: #b91c1c;
            color: #ffffff;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>

<body>
    <!-- Loading View -->
    <div id="loading-view" class="hidden">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading-spinner mb-4" style="margin: 0 auto;"></div>
                <h2 class="text-xl font-bold text-amber-400 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
                <p class="text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Prima789</p>
            </div>
        </div>
    </div>

    <!-- Login Required View -->
    <div id="login-view" class="hidden">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="max-w-md w-full">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 bg-amber-400 rounded-full mb-4 flex items-center justify-center" style="margin: 0 auto;">
                        <span class="text-4xl">üé∞</span>
                    </div>
                    <h1 class="text-2xl font-bold text-amber-400 mb-2">Prima789</h1>
                    <p class="text-gray-300">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-center mb-4">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
                    <p class="text-gray-300 text-center mb-6">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ö Prima789
                    </p>
                    
                    <button id="connect-btn" class="btn btn-primary w-full">
                        üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Prima789
                    </button>
                </div>

                <div class="text-center text-sm text-gray-400">
                    <p>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Card View -->
    <div id="card-view" class="hidden">
        <div class="min-h-screen p-4">
            <!-- Header -->
            <div class="text-center mb-6 fade-in">
                <h1 class="text-2xl font-bold text-amber-400 mb-2">üé∞ Prima789 Member</h1>
                <p class="text-gray-400">‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</p>
            </div>

            <!-- Member Card -->
            <div class="max-w-md">
                <div class="bg-gray-800 rounded-2xl p-6 mb-6 shadow-lg fade-in">
                    <!-- LINE Profile -->
                    <div class="flex items-center mb-6 pb-4" style="border-bottom: 1px solid #374151;">
                        <img id="line-avatar" src="" alt="Profile" 
                             class="w-16 h-16 rounded-full border-2 border-amber-400 mr-4">
                        <div class="flex-1">
                            <h3 id="line-name" class="text-lg font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
                            <p class="text-sm text-gray-400">LINE Account</p>
                        </div>
                        <div class="text-center">
                            <div class="w-3 h-3 rounded-full" style="background-color: #4ade80; margin: 0 auto;"></div>
                            <p class="text-xs text-green-400">Online</p>
                        </div>
                    </div>

                    <!-- Member Info -->
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Username:</span>
                            <span id="prima-username" class="font-medium">-</span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
                            <span id="prima-phone" class="font-medium">-</span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-400">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</span>
                            <span id="member-level" class="font-bold text-amber-400">-</span>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-4 mt-6">
                            <div class="text-center">
                                <p class="text-sm text-gray-400 mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                                <p id="prima-balance" class="text-2xl font-bold text-amber-400">‡∏ø0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-6 space-y-3">
                        <button id="refresh-btn" class="btn btn-secondary w-full">
                            üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>

                <!-- Status -->
                <div class="text-center text-xs text-gray-500">
                    <p>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-updated">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Error View -->
    <div id="error-view" class="hidden">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="max-w-md w-full text-center">
                <div class="w-24 h-24 bg-red-900 rounded-full mb-4 flex items-center justify-center" style="margin: 0 auto;">
                    <span class="text-4xl text-red-400">‚ö†Ô∏è</span>
                </div>
                
                <h2 class="text-2xl font-bold text-red-400 mb-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
                <p id="error-message" class="text-gray-300 mb-6">
                    ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
                </p>
                
                <button onclick="location.reload()" class="btn btn-danger">
                    ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const LIFF_ID = '2008101230-z37JaYn1';
        const API_BASE_URL = '/.netlify/functions/api';
        
        // Global variables
        let lineProfile = null;
        let primaData = null;
        
        // Utility functions
        function showView(viewId) {
            const views = ['loading-view', 'login-view', 'card-view', 'error-view'];
            views.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === viewId) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                }
            });
        }
        
        function handleError(message) {
            console.error('Error:', message);
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.textContent = message;
            }
            showView('error-view');
        }
        
        // Initialize app
        async function initializeApp() {
            try {
                console.log('üöÄ Initializing LIFF...');
                showView('loading-view');
                
                // Check if LIFF SDK is loaded
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK not loaded');
                }
                
                // Initialize LIFF
                await liff.init({ 
                    liffId: LIFF_ID,
                    withLoginOnExternalBrowser: true
                });
                
                console.log('‚úÖ LIFF initialized successfully');
                console.log('üì± LIFF environment:', {
                    inClient: liff.isInClient(),
                    loggedIn: liff.isLoggedIn(),
                    os: liff.getOS(),
                    version: liff.getVersion()
                });
                
                // Check login status
                if (!liff.isLoggedIn()) {
                    console.log('‚ö†Ô∏è User not logged in');
                    showView('login-view');
                    return;
                }
                
                // Get LINE profile
                lineProfile = await liff.getProfile();
                console.log('üë§ LINE Profile:', lineProfile);
                
                // Display profile
                displayLineProfile();
                
                // Check sync status
                await checkSyncStatus();
                
            } catch (error) {
                console.error('‚ùå App initialization failed:', error);
                handleError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE LIFF ‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }
        
        // Display LINE profile information
        function displayLineProfile() {
            if (!lineProfile) return;
            
            const nameEl = document.getElementById('line-name');
            const avatarEl = document.getElementById('line-avatar');
            
            if (nameEl) nameEl.textContent = lineProfile.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            
            if (avatarEl) {
                if (lineProfile.pictureUrl) {
                    avatarEl.src = lineProfile.pictureUrl;
                } else {
                    // Generate avatar from name
                    const name = lineProfile.displayName || 'User';
                    avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=f59e0b&color=1f2937&size=64`;
                }
            }
        }
        
        // Check sync status with Prima789
        async function checkSyncStatus() {
            try {
                console.log('üîç Checking sync status...');
                
                const response = await fetch(`${API_BASE_URL}/user/profile`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-LINE-User-ID': lineProfile.userId
                    }
                });
                
                if (response.ok) {
                    primaData = await response.json();
                    console.log('‚úÖ User data found:', primaData);
                    displayMemberCard();
                    showView('card-view');
                } else if (response.status === 404) {
                    // User not synced yet
                    console.log('‚ö†Ô∏è User not synced');
                    showView('login-view');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Sync status check failed:', error);
                handleError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }
        
        // Display member card data
        function displayMemberCard() {
            if (!primaData) return;
            
            // Update UI elements safely
            const updates = {
                'prima-username': primaData.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                'prima-phone': primaData.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                'member-level': primaData.level || 'STANDARD',
                'last-updated': new Date().toLocaleString('th-TH')
            };
            
            // Handle balance formatting
            let balanceText = '‡∏ø0.00';
            if (primaData.balance !== undefined && primaData.balance !== null) {
                const balance = parseFloat(primaData.balance);
                if (!isNaN(balance)) {
                    balanceText = `‡∏ø${balance.toLocaleString('th-TH', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                }
            }
            updates['prima-balance'] = balanceText;
            
            // Apply updates
            for (const [elementId, value] of Object.entries(updates)) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Connect button
            const connectBtn = document.getElementById('connect-btn');
            if (connectBtn) {
                connectBtn.addEventListener('click', function() {
                    if (lineProfile) {
                        // Open integration page
                        const integrationUrl = `/prima789-integration.html?lineUserId=${encodeURIComponent(lineProfile.userId)}&displayName=${encodeURIComponent(lineProfile.displayName)}`;
                        
                        if (liff && liff.isInClient()) {
                            liff.openWindow({ url: integrationUrl, external: false });
                        } else {
                            window.open(integrationUrl, '_blank');
                        }
                    } else if (liff) {
                        liff.login();
                    } else {
                        handleError('LINE LIFF ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    }
                });
            }
            
            // Refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    if (lineProfile) {
                        showView('loading-view');
                        setTimeout(() => checkSyncStatus(), 500);
                    } else {
                        handleError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE Profile');
                    }
                });
            }
            
            // Initialize app
            setTimeout(initializeApp, 100);
        });
        
        // Listen for sync success from integration window
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'PRIMA_SYNC_SUCCESS') {
                console.log('üéâ Sync successful, refreshing data...');
                showView('loading-view');
                setTimeout(() => checkSyncStatus(), 1000);
            }
        });
        
        // Global refresh function
        window.refreshData = function() {
            if (lineProfile) {
                showView('loading-view');
                checkSyncStatus();
            } else {
                handleError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE Profile');
            }
        };
    </script>
</body>
</html>