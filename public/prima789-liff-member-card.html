<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prima789 Member Card</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.27.2/sdk.js"></script>
  <script src="assets/tailwind.min.css"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-shadow {
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .input-focus {
      transition: all 0.3s ease;
    }
    .input-focus:focus {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg text-white py-6 px-4">
    <div class="max-w-md mx-auto text-center">
      <h1 class="text-2xl font-bold">Prima789</h1>
      <p class="text-blue-100 mt-1">Member Card System</p>
    </div>
  </header>

  <!-- Main Content -->
  <div class="max-w-md mx-auto px-4 py-6">
    
    <!-- Status Card -->
    <div id="statusCard" class="bg-white rounded-lg card-shadow p-6 mb-6">
      <div class="text-center">
        <div id="statusIcon" class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
          <span class="text-2xl">üîÑ</span>
        </div>
        <h2 id="statusTitle" class="text-xl font-semibold text-gray-800 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</h2>
        <p id="statusMessage" class="text-gray-600">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
      </div>
    </div>

    <!-- Login Form (Hidden initially) -->
    <div id="loginForm" class="bg-white rounded-lg card-shadow p-6 mb-6" style="display: none;">
      <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Prima789</h3>
      
      <form id="syncForm">
        <!-- Phone Number Input -->
        <div class="mb-4">
          <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-2">
            ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
          </label>
          <input 
            type="tel" 
            id="phoneNumber" 
            name="phoneNumber"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="08XXXXXXXX"
            pattern="[0-9]{10}"
            maxlength="10"
            required
          >
          <p class="text-xs text-gray-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö Prima789</p>
        </div>

        <!-- PIN Input -->
        <div class="mb-6">
          <label for="pinCode" class="block text-sm font-medium text-gray-700 mb-2">
            ‡∏£‡∏´‡∏±‡∏™ PIN (4 ‡∏´‡∏•‡∏±‡∏Å)
          </label>
          <input 
            type="password" 
            id="pinCode" 
            name="pinCode"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg tracking-widest"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            pattern="[0-9]{4}"
            maxlength="4"
            required
          >
          <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô Prima789</p>
        </div>

        <!-- Submit Button -->
        <button 
          type="submit" 
          id="syncButton"
          class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="syncButtonText">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
          <span id="syncButtonLoader" class="hidden">
            <span class="pulse-animation">üîÑ</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
          </span>
        </button>
      </form>
    </div>

    <!-- Member Card (Hidden initially) -->
    <div id="memberCard" class="bg-white rounded-lg card-shadow p-6 mb-6" style="display: none;">
      <div class="gradient-bg text-white rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">Prima789 Member Card</h3>
        
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-blue-100">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span>
            <span id="memberUsername" class="font-semibold">-</span>
          </div>
          
          <div class="flex justify-between items-center">
            <span class="text-blue-100">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</span>
            <span id="memberTier" class="font-semibold">-</span>
          </div>
          
          <div class="flex justify-between items-center">
            <span class="text-blue-100">‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï:</span>
            <span id="creditBalance" class="font-semibold">-</span>
          </div>
          
          <div class="flex justify-between items-center text-sm">
            <span class="text-blue-100">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
            <span id="lastUpdate" class="text-blue-100">-</span>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="mt-4 space-y-2">
        <button id="refreshButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
          üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button id="disconnectButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
          üîå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4" style="display: none;">
      <div class="flex items-center">
        <span class="mr-2">‚ö†Ô∏è</span>
        <span id="errorText">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer class="text-center py-6 px-4 text-gray-500 text-sm">
    <p>&copy; 2025 Prima789 Member Card System</p>
    <p class="mt-1">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ LINE LIFF Technology</p>
  </footer>

  <script>
    // LIFF Configuration
    const LIFF_ID = '2008101230-z37JaYn1'; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ LIFF ID ‡∏à‡∏£‡∏¥‡∏á
    const API_BASE_URL = '/.netlify/functions/api';

    // DOM Elements
    const statusCard = document.getElementById('statusCard');
    const statusIcon = document.getElementById('statusIcon');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    
    const loginForm = document.getElementById('loginForm');
    const syncForm = document.getElementById('syncForm');
    const phoneNumberInput = document.getElementById('phoneNumber');
    const pinCodeInput = document.getElementById('pinCode');
    const syncButton = document.getElementById('syncButton');
    const syncButtonText = document.getElementById('syncButtonText');
    const syncButtonLoader = document.getElementById('syncButtonLoader');
    
    const memberCard = document.getElementById('memberCard');
    const memberUsername = document.getElementById('memberUsername');
    const memberTier = document.getElementById('memberTier');
    const creditBalance = document.getElementById('creditBalance');
    const lastUpdate = document.getElementById('lastUpdate');
    
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const refreshButton = document.getElementById('refreshButton');
    const disconnectButton = document.getElementById('disconnectButton');

    // Utility Functions
    function showError(message) {
      errorText.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    function updateStatus(icon, title, message) {
      statusIcon.innerHTML = `<span class="text-2xl">${icon}</span>`;
      statusTitle.textContent = title;
      statusMessage.textContent = message;
    }

    function formatPhoneNumber(phone) {
      // Remove all non-digits
      phone = phone.replace(/\D/g, '');
      
      // Ensure it starts with 0 for Thai mobile numbers
      if (phone.length === 9 && ['8', '9', '6'].includes(phone[0])) {
        phone = '0' + phone;
      }
      
      return phone;
    }

    function validatePhoneNumber(phone) {
      const cleanPhone = formatPhoneNumber(phone);
      return /^0[689]\d{8}$/.test(cleanPhone);
    }

    function validatePIN(pin) {
      return /^\d{4}$/.test(pin);
    }

    // API Functions
    async function checkSyncStatus() {
      try {
        const accessToken = liff.getAccessToken();
        
        const response = await fetch(`${API_BASE_URL}/status`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => null);
          throw new Error(errorData?.error?.message || `Server error: ${response.status}`);
        }

        const data = await response.json();
        return data;

      } catch (error) {
        console.error('Failed to check sync status:', error);
        throw error;
      }
    }

    async function syncAccount(phoneNumber, pinCode) {
      try {
        const accessToken = liff.getAccessToken();
        
        const response = await fetch(`${API_BASE_URL}/sync`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: formatPhoneNumber(phoneNumber),
            password: pinCode
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => null);
          throw new Error(errorData?.error?.message || `Server error: ${response.status}`);
        }

        const data = await response.json();
        return data;

      } catch (error) {
        console.error('Failed to sync account:', error);
        throw error;
      }
    }

    // UI Functions
    function showLoginForm() {
      statusCard.style.display = 'none';
      loginForm.style.display = 'block';
      memberCard.style.display = 'none';
    }

    function showMemberCard(memberData) {
      statusCard.style.display = 'none';
      loginForm.style.display = 'none';
      memberCard.style.display = 'block';
      
      memberUsername.textContent = memberData.primaUsername || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      memberTier.textContent = memberData.memberTier || 'Standard';
      creditBalance.textContent = memberData.creditBalance || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      
      if (memberData.syncedAt) {
        const date = new Date(memberData.syncedAt);
        lastUpdate.textContent = date.toLocaleString('th-TH');
      }
    }

    function showStatus(icon, title, message) {
      statusCard.style.display = 'block';
      loginForm.style.display = 'none';
      memberCard.style.display = 'none';
      
      updateStatus(icon, title, message);
    }

    // Event Handlers
    syncForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const phoneNumber = phoneNumberInput.value.trim();
      const pinCode = pinCodeInput.value.trim();

      // Validate inputs
      if (!validatePhoneNumber(phoneNumber)) {
        showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (08X, 09X, 06X)');
        phoneNumberInput.focus();
        return;
      }

      if (!validatePIN(pinCode)) {
        showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å');
        pinCodeInput.focus();
        return;
      }

      // Show loading state
      syncButton.disabled = true;
      syncButtonText.style.display = 'none';
      syncButtonLoader.style.display = 'inline';

      try {
        const result = await syncAccount(phoneNumber, pinCode);
        
        if (result.synced && result.memberData) {
          showMemberCard(result.memberData);
          showError = () => {}; // Hide any previous errors
        } else {
          throw new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }

      } catch (error) {
        showError('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
      } finally {
        // Reset button state
        syncButton.disabled = false;
        syncButtonText.style.display = 'inline';
        syncButtonLoader.style.display = 'none';
      }
    });

    // Input formatting and validation
    phoneNumberInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length > 10) {
        value = value.slice(0, 10);
      }
      
      e.target.value = value;
      
      // Visual feedback
      if (value.length === 10 && validatePhoneNumber(value)) {
        e.target.classList.remove('border-red-500');
        e.target.classList.add('border-green-500');
      } else if (value.length > 0) {
        e.target.classList.remove('border-green-500');
        e.target.classList.add('border-red-500');
      } else {
        e.target.classList.remove('border-green-500', 'border-red-500');
      }
    });

    pinCodeInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length > 4) {
        value = value.slice(0, 4);
      }
      
      e.target.value = value;
      
      // Visual feedback
      if (value.length === 4) {
        e.target.classList.remove('border-red-500');
        e.target.classList.add('border-green-500');
      } else if (value.length > 0) {
        e.target.classList.remove('border-green-500');
        e.target.classList.add('border-red-500');
      } else {
        e.target.classList.remove('border-green-500', 'border-red-500');
      }
    });

    // Refresh button
    refreshButton?.addEventListener('click', async () => {
      showStatus('üîÑ', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
      
      try {
        const result = await checkSyncStatus();
        if (result.synced && result.memberData) {
          showMemberCard(result.memberData);
        } else {
          showLoginForm();
        }
      } catch (error) {
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message);
        showLoginForm();
      }
    });

    // Disconnect button
    disconnectButton?.addEventListener('click', () => {
      if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        showLoginForm();
        phoneNumberInput.value = '';
        pinCodeInput.value = '';
      }
    });

    // LIFF Initialization
    async function initializeLiff() {
      try {
        updateStatus('üîÑ', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...', '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
        
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        updateStatus('üîç', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
        
        try {
          const result = await checkSyncStatus();
          
          if (result.synced && result.memberData) {
            showMemberCard(result.memberData);
          } else {
            showLoginForm();
          }
        } catch (error) {
          console.error('Status check failed:', error);
          updateStatus('‚ö†Ô∏è', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', '‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
          setTimeout(() => {
            showLoginForm();
          }, 2000);
        }

      } catch (error) {
        console.error('LIFF initialization failed:', error);
        updateStatus('‚ùå', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', error.message);
      }
    }

    // Start the application
    initializeLiff();
  </script>
</body>
</html>