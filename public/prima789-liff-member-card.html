<!-- แก้ไขในไฟล์ prima789-liff-member-card.html -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima789 Member Card</title>
    
    <!-- HTTPS และ Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https:;
        script-src 'self' 'unsafe-inline' https://static.line-scdn.net https://d.line-scdn.net;
        connect-src 'self' https://api.line.me https://access.line.me https://liffsdk.line-scdn.net https://prima168.online https://slaczcardmem.netlify.app;
        img-src 'self' data: https: blob:;
        style-src 'self' 'unsafe-inline' https:;
    ">
    
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <!-- HTML content ไม่เปลี่ยน -->
    
    <script>
        // Production Configuration
        const LIFF_ID = '2008101230-z37JaYn1'; // ตรวจสอบว่าถูกต้อง
        const API_BASE_URL = 'https://slaczcardmem.netlify.app/.netlify/functions/api';
        
        // ตัวแปรสำหรับเก็บข้อมูล
        let lineProfile = null;
        let primaData = null;
        
        // Initialize LIFF ด้วย error handling ที่ดีขึ้น
        async function initializeLiff() {
            try {
                console.log('🚀 Initializing LIFF...');
                
                // ตรวจสอบ LIFF SDK
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK ไม่ได้โหลด กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
                }
                
                // Initialize LIFF
                await liff.init({ 
                    liffId: LIFF_ID,
                    withLoginOnExternalBrowser: true // สำคัญสำหรับ external browser
                });
                
                console.log('✅ LIFF initialized successfully');
                console.log('📱 LIFF environment:', {
                    inClient: liff.isInClient(),
                    loggedIn: liff.isLoggedIn(),
                    os: liff.getOS(),
                    version: liff.getVersion()
                });
                
                // ตรวจสอบการล็อกอิน
                if (!liff.isLoggedIn()) {
                    console.log('⚠️ User not logged in');
                    showView('login-required-view');
                    return;
                }
                
                // ดึงข้อมูล Profile
                lineProfile = await liff.getProfile();
                console.log('👤 LINE Profile:', lineProfile);
                
                displayLineProfile();
                await checkPrimaConnection();
                
            } catch (error) {
                console.error('❌ LIFF Initialization failed:', error);
                
                // แสดงข้อผิดพลาดที่เข้าใจง่าย
                let errorMessage = 'ไม่สามารถเชื่อมต่อกับ LINE ได้';
                
                if (error.message.includes('LIFF ID')) {
                    errorMessage = 'การตั้งค่า LIFF ID ไม่ถูกต้อง';
                } else if (error.message.includes('network')) {
                    errorMessage = 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
                } else if (error.message.includes('Load failed')) {
                    errorMessage = 'ไม่สามารถโหลด LIFF SDK ได้ กรุณาลองใหม่';
                }
                
                document.getElementById('error-message').textContent = errorMessage;
                showView('error-view');
            }
        }
        
        // ฟังก์ชันตรวจสอบการเชื่อมต่อ Prima789
        async function checkPrimaConnection() {
            try {
                showView('loading-view');
                
                const response = await fetch(`${API_BASE_URL}/user/profile`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-LINE-User-ID': lineProfile.userId
                    }
                });
                
                if (response.ok) {
                    primaData = await response.json();
                    displayMemberCard();
                    showView('card-view');
                } else if (response.status === 404) {
                    // ยังไม่ได้เชื่อมต่อบัญชี
                    showView('login-required-view');
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error checking Prima connection:', error);
                document.getElementById('error-message').textContent = 
                    'ไม่สามารถตรวจสอบสถานะการเชื่อมต่อได้ กรุณาลองใหม่อีกครั้ง';
                showView('error-view');
            }
        }
        
        // ฟังก์ชันแสดงข้อมูล LINE Profile
        function displayLineProfile() {
            const { userId, displayName, pictureUrl } = lineProfile;
            
            document.getElementById('line-display-name').textContent = displayName || 'ไม่ระบุชื่อ';
            document.getElementById('line-user-id').textContent = userId;
            
            if (pictureUrl) {
                document.getElementById('line-picture').src = pictureUrl;
            }
        }
        
        // ฟังก์ชันแสดง Member Card
        function displayMemberCard() {
            if (!primaData) return;
            
            // อัพเดตข้อมูลในการ์ด
            document.getElementById('prima-username').textContent = primaData.username || 'ไม่ระบุ';
            document.getElementById('prima-phone').textContent = primaData.phone || 'ไม่ระบุ';
            document.getElementById('prima-balance').textContent = 
                primaData.balance ? `${primaData.balance.toLocaleString()} บาท` : 'ไม่ระบุ';
            document.getElementById('member-level').textContent = primaData.level || 'BRONZE';
            
            // อัพเดต timestamp
            document.getElementById('last-updated').textContent = 
                new Date().toLocaleString('th-TH');
        }
        
        // จัดการการแสดงผล Views
        function showView(viewId) {
            const views = ['loading-view', 'login-required-view', 'card-view', 'error-view'];
            views.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === viewId) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                }
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Login button
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', function() {
                    if (liff.isLoggedIn()) {
                        // เปิดหน้าเชื่อมต่อ Prima789
                        const connectUrl = `prima789-integration.html?lineUserId=${encodeURIComponent(lineProfile.userId)}&displayName=${encodeURIComponent(lineProfile.displayName)}`;
                        liff.openWindow({ url: connectUrl, external: false });
                    } else {
                        liff.login();
                    }
                });
            }
            
            // Refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    if (lineProfile) {
                        checkPrimaConnection();
                    }
                });
            }
            
            // Initialize LIFF
            initializeLiff();
        });
        
        // Listen for messages from integration window
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'PRIMA_SYNC_SUCCESS') {
                console.log('🎉 Prima sync successful, refreshing data...');
                checkPrimaConnection();
            }
        });
        
        // Global refresh function
        window.refreshPrimaData = function() {
            if (lineProfile) {
                checkPrimaConnection();
            }
        };
        
    </script>
</body>
</html>