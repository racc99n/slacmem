<!-- à¹à¸à¹‰à¹„à¸‚à¹ƒà¸™à¹„à¸Ÿà¸¥à¹Œ prima789-liff-member-card.html -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima789 Member Card</title>
    
    <!-- HTTPS à¹à¸¥à¸° Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https:;
        script-src 'self' 'unsafe-inline' https://static.line-scdn.net https://d.line-scdn.net;
        connect-src 'self' https://api.line.me https://access.line.me https://liffsdk.line-scdn.net https://prima168.online https://slaczcardmem.netlify.app;
        img-src 'self' data: https: blob:;
        style-src 'self' 'unsafe-inline' https:;
    ">
    
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <!-- HTML content à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ -->
    
    <script>
        // Production Configuration
        const LIFF_ID = '2008101230-z37JaYn1'; // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
        const API_BASE_URL = 'https://slaczcardmem.netlify.app/.netlify/functions/api';
        
        // à¸•à¸±à¸§à¹à¸›à¸£à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
        let lineProfile = null;
        let primaData = null;
        
        // Initialize LIFF à¸”à¹‰à¸§à¸¢ error handling à¸—à¸µà¹ˆà¸”à¸µà¸‚à¸¶à¹‰à¸™
        async function initializeLiff() {
            try {
                console.log('ðŸš€ Initializing LIFF...');
                
                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š LIFF SDK
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹‚à¸«à¸¥à¸” à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸­à¸´à¸™à¹€à¸—à¸­à¸£à¹Œà¹€à¸™à¹‡à¸•');
                }
                
                // Initialize LIFF
                await liff.init({ 
                    liffId: LIFF_ID,
                    withLoginOnExternalBrowser: true // à¸ªà¸³à¸„à¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸š external browser
                });
                
                console.log('âœ… LIFF initialized successfully');
                console.log('ðŸ“± LIFF environment:', {
                    inClient: liff.isInClient(),
                    loggedIn: liff.isLoggedIn(),
                    os: liff.getOS(),
                    version: liff.getVersion()
                });
                
                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸¥à¹‡à¸­à¸à¸­à¸´à¸™
                if (!liff.isLoggedIn()) {
                    console.log('âš ï¸ User not logged in');
                    showView('login-required-view');
                    return;
                }
                
                // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Profile
                lineProfile = await liff.getProfile();
                console.log('ðŸ‘¤ LINE Profile:', lineProfile);
                
                displayLineProfile();
                await checkPrimaConnection();
                
            } catch (error) {
                console.error('âŒ LIFF Initialization failed:', error);
                
                // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢
                let errorMessage = 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š LINE à¹„à¸”à¹‰';
                
                if (error.message.includes('LIFF ID')) {
                    errorMessage = 'à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² LIFF ID à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡';
                } else if (error.message.includes('network')) {
                    errorMessage = 'à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸­à¸´à¸™à¹€à¸—à¸­à¸£à¹Œà¹€à¸™à¹‡à¸•';
                } else if (error.message.includes('Load failed')) {
                    errorMessage = 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸” LIFF SDK à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ';
                }
                
                document.getElementById('error-message').textContent = errorMessage;
                showView('error-view');
            }
        }
        
        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Prima789
        async function checkPrimaConnection() {
            try {
                showView('loading-view');
                
                const response = await fetch(`${API_BASE_URL}/user/profile`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-LINE-User-ID': lineProfile.userId
                    }
                });
                
                if (response.ok) {
                    primaData = await response.json();
                    displayMemberCard();
                    showView('card-view');
                } else if (response.status === 404) {
                    // à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ
                    showView('login-required-view');
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error checking Prima connection:', error);
                document.getElementById('error-message').textContent = 
                    'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡';
                showView('error-view');
            }
        }
        
        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ LINE Profile
        function displayLineProfile() {
            const { userId, displayName, pictureUrl } = lineProfile;
            
            document.getElementById('line-display-name').textContent = displayName || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
            document.getElementById('line-user-id').textContent = userId;
            
            if (pictureUrl) {
                document.getElementById('line-picture').src = pictureUrl;
            }
        }
        
        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡ Member Card
        function displayMemberCard() {
            if (!primaData) return;
            
            // à¸­à¸±à¸žà¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸à¸²à¸£à¹Œà¸”
            document.getElementById('prima-username').textContent = primaData.username || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸';
            document.getElementById('prima-phone').textContent = primaData.phone || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸';
            document.getElementById('prima-balance').textContent = 
                primaData.balance ? `${primaData.balance.toLocaleString()} à¸šà¸²à¸—` : 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸';
            document.getElementById('member-level').textContent = primaData.level || 'BRONZE';
            
            // à¸­à¸±à¸žà¹€à¸”à¸• timestamp
            document.getElementById('last-updated').textContent = 
                new Date().toLocaleString('th-TH');
        }
        
        // à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥ Views
        function showView(viewId) {
            const views = ['loading-view', 'login-required-view', 'card-view', 'error-view'];
            views.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === viewId) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                }
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Login button
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', function() {
                    if (liff.isLoggedIn()) {
                        // à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Prima789
                        const connectUrl = `prima789-integration.html?lineUserId=${encodeURIComponent(lineProfile.userId)}&displayName=${encodeURIComponent(lineProfile.displayName)}`;
                        liff.openWindow({ url: connectUrl, external: false });
                    } else {
                        liff.login();
                    }
                });
            }
            
            // Refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    if (lineProfile) {
                        checkPrimaConnection();
                    }
                });
            }
            
            // Initialize LIFF
            initializeLiff();
        });
        
        // Listen for messages from integration window
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'PRIMA_SYNC_SUCCESS') {
                console.log('ðŸŽ‰ Prima sync successful, refreshing data...');
                checkPrimaConnection();
            }
        });
        
        // Global refresh function
        window.refreshPrimaData = function() {
            if (lineProfile) {
                checkPrimaConnection();
            }
        };
        
    </script>
</body>
</html>