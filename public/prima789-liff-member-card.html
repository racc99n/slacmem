<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima789 Member Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chosen Palette: Midnight Gold -->
    <!-- Application Structure Plan: ผมได้ออกแบบแอปพลิเคชันเป็น Single-Page Application (SPA) ที่จัดการมุมมอง (View) ต่างๆ ผ่าน JavaScript แทนการโหลดหน้าใหม่ทั้งหมด โครงสร้างนี้ประกอบด้วย 4 สถานะหลัก: 1. **Loading View:** แสดงผลขณะกำลังเริ่มต้น LIFF และตรวจสอบสถานะการเชื่อมต่อบัญชี 2. **Login View:** แสดงผลเมื่อผู้ใช้ยังไม่ได้เชื่อมต่อบัญชี LINE กับ Prima789 3. **Card View:** แสดงบัตรสมาชิกเมื่อผู้ใช้เชื่อมต่อบัญชีเรียบร้อยแล้ว 4. **Error View:** แสดงผลเมื่อเกิดข้อผิดพลาด เหตุผลที่เลือกโครงสร้างนี้เพราะมอบประสบการณ์ผู้ใช้ที่ราบรื่น (Seamless UX) โดยไม่ต้องออกจาก LIFF App ไปยังเบราว์เซอร์ภายนอก ทำให้กระบวนการทั้งหมดเสร็จสิ้นในที่เดียว และง่ายต่อการจัดการสถานะของแอปพลิเคชัน -->
    <!-- Visualization & Content Choices: Goal: แสดงข้อมูลสมาชิกและอำนวยความสะดวกในการเชื่อมบัญชี -> Viz/Presentation Method: ใช้การ์ดดีไซน์ที่สวยงามสำหรับข้อมูลสมาชิก (Card View) และฟอร์มล็อกอินที่เรียบง่าย (Login View) -> Interaction: ผู้ใช้กรอกข้อมูลในฟอร์มเพื่อส่งคำขอเชื่อมบัญชี ข้อมูลบนบัตรสมาชิกจะถูกดึงมาแสดงผลอัตโนมัติ -> Justification: การ์ดเป็นรูปแบบที่คนคุ้นเคยสำหรับบัตรสมาชิก และฟอร์มเป็นมาตรฐานสำหรับการยืนยันตัวตน วิธีนี้ตรงไปตรงมาและเข้าใจง่ายที่สุดสำหรับผู้ใช้ -> Library/Method: ใช้ Tailwind CSS สำหรับการออกแบบ UI ทั้งหมด และใช้ Vanilla JavaScript ในการจัดการสถานะและข้อมูล ไม่มีการใช้กราฟิกซับซ้อน -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .bg-gradient-dark {
            background-image: linear-gradient(to top right, #1a202c, #2d3748);
        }
        .card-gradient {
            background-image: linear-gradient(145deg, #2d3748, #4a5568);
        }
        .btn-primary {
            background-color: #f59e0b;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #d97706;
        }
        .form-input {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        .form-input:focus {
            --tw-ring-color: #f59e0b;
            border-color: #f59e0b;
        }
        .hidden {
            display: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-dark text-white min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- Loading View -->
        <div id="loading-view" class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-amber-400"></i>
            <p class="mt-4 text-lg">กำลังเตรียมข้อมูล...</p>
        </div>

        <!-- Login View -->
        <div id="login-view" class="hidden">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl">
                <div class="text-center mb-6">
                    <img src="https://placehold.co/100x100/f59e0b/1a202c?text=P789" alt="Prima789 Logo" class="mx-auto rounded-full mb-4 w-24 h-24 border-4 border-amber-400">
                    <h1 class="text-3xl font-bold text-amber-400">เชื่อมต่อบัญชี</h1>
                    <p class="text-gray-400 mt-2">กรุณาเข้าสู่ระบบ Prima789 เพื่อใช้งานบัตรสมาชิก</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block mb-2 text-sm font-medium text-gray-300">ชื่อผู้ใช้</label>
                        <input type="text" id="username" name="username" class="form-input w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block mb-2 text-sm font-medium text-gray-300">รหัสผ่าน</label>
                        <input type="password" id="password" name="password" class="form-input w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2" required>
                    </div>
                    <button type="submit" id="login-button" class="btn-primary w-full text-gray-900 font-bold py-3 px-4 rounded-lg shadow-lg">
                        <span id="login-button-text">เชื่อมต่อบัญชี</span>
                        <i id="login-button-spinner" class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                </form>
                <p id="login-error" class="text-red-400 text-center mt-4 text-sm"></p>
            </div>
        </div>

        <!-- Card View -->
        <div id="card-view" class="hidden">
            <div class="card-gradient w-full mx-auto rounded-2xl shadow-2xl p-6 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-amber-500/20 rounded-full filter blur-xl"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs text-amber-300 uppercase tracking-widest">Member Card</p>
                            <h2 class="text-2xl font-bold">PRIMA789</h2>
                        </div>
                        <img id="line-picture" src="https://placehold.co/64x64/ffffff/1a202c?text=User" alt="LINE Profile" class="w-16 h-16 rounded-full border-2 border-amber-400">
                    </div>

                    <div class="mb-6 text-center">
                        <p class="text-lg text-gray-300">สวัสดีคุณ,</p>
                        <h3 id="line-display-name" class="text-3xl font-semibold text-amber-400 truncate">-</h3>
                    </div>

                    <div class="bg-black/20 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-400">ชื่อผู้ใช้ Prima789</p>
                                <p id="prima-username" class="font-medium text-lg">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-400">ระดับสมาชิก</p>
                                <p id="member-tier" class="font-medium text-lg">-</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-xs text-gray-400">ยอดเครดิตคงเหลือ</p>
                                <p id="credit-balance" class="font-bold text-2xl text-amber-300">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-xs text-gray-500">LINE User ID:</p>
                        <p id="line-user-id" class="text-xs text-gray-400 break-all">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error View -->
        <div id="error-view" class="hidden text-center bg-red-900/50 p-6 rounded-lg">
            <i class="fas fa-exclamation-circle text-4xl text-red-400"></i>
            <h2 class="text-2xl font-bold mt-4">เกิดข้อผิดพลาด</h2>
            <p id="error-message" class="text-red-300 mt-2">ไม่สามารถเริ่มต้น LIFF ได้</p>
        </div>

    </div>

    <script>
        const LIFF_ID = '2008101230-z37JaYn1';
        const API_BASE_URL = 'https://slaczcardmem.netlify.app/api';

        const views = ['loading-view', 'login-view', 'card-view', 'error-view'];

        function showView(viewId) {
            views.forEach(id => {
                const element = document.getElementById(id);
                if (id === viewId) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            });
        }

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                checkSyncStatus(profile);
            } catch (error) {
                console.error('LIFF Initialization failed', error);
                document.getElementById('error-message').textContent = 'ไม่สามารถเริ่มต้น LIFF ได้ กรุณาลองใหม่อีกครั้ง';
                showView('error-view');
            }
        }

        async function checkSyncStatus(lineProfile) {
            const { userId, displayName, pictureUrl } = lineProfile;

            document.getElementById('line-display-name').textContent = displayName;
            document.getElementById('line-user-id').textContent = userId;
            if(pictureUrl) {
                document.getElementById('line-picture').src = pictureUrl;
            }

            try {
                const idToken = liff.getIDToken();
                if (!idToken) {
                    throw new Error('Could not get ID Token.');
                }

                const response = await fetch(`${API_BASE_URL}/status`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.synced) {
                        displayMemberCard(data.memberData);
                    } else {
                        displayLoginView();
                    }
                } else {
                    throw new Error('Server error while checking status');
                }
            } catch (error) {
                console.error('Failed to check sync status', error);
                document.getElementById('error-message').textContent = 'ไม่สามารถตรวจสอบสถานะบัญชีได้';
                showView('error-view');
            }
        }

        function displayLoginView() {
            showView('login-view');
            const loginForm = document.getElementById('login-form');
            
            const handleSubmit = async (event) => {
                event.preventDefault();
                handleLogin();
            };

            // ป้องกันการ add event listener ซ้ำซ้อน
            if (loginForm.lastSubmitHandler) {
                loginForm.removeEventListener('submit', loginForm.lastSubmitHandler);
            }
            loginForm.addEventListener('submit', handleSubmit);
            loginForm.lastSubmitHandler = handleSubmit;
        }

        async function handleLogin(lineUserId) {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            const loginButton = document.getElementById('login-button');
            const buttonText = document.getElementById('login-button-text');
            const buttonSpinner = document.getElementById('login-button-spinner');

            errorElement.textContent = '';
            buttonText.classList.add('hidden');
            buttonSpinner.classList.remove('hidden');
            loginButton.disabled = true;

            try {
                const idToken = liff.getIDToken();
                if (!idToken) {
                    throw new Error('Could not get ID Token for login.');
                }

                const response = await fetch(`${API_BASE_URL}/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMemberCard(data.memberData);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
                }
                
            } catch (error) {
                errorElement.textContent = error.message;
            } finally {
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
                loginButton.disabled = false;
            }
        }

        function displayMemberCard(userData) {
            document.getElementById('prima-username').textContent = userData.primaUsername;
            document.getElementById('member-tier').textContent = userData.memberTier;
            document.getElementById('credit-balance').textContent = `฿${userData.creditBalance}`;
            showView('card-view');
        }

        window.onload = main;
    </script>
</body>
</html>
